generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model app_users {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username           String    @unique
  password           String
  real_name          String
  role               String?   @default("farmer")
  account_status     String?   @default("active") // active, pending, rejected
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
}

model batches {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_no       String
  variety        String
  location       String
  sowing_date    DateTime  @db.Date
  status         String?   @default("growing")

  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  user_id        String?
  records        records[]
  inspections    inspections[]
  feedbacks      feedbacks[]
  logistics      logistics[]
  alerts         alerts[]
}

model records {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id    String    @db.Uuid
  action_type String
  description String?
  images      String[]
  operator    String?   @default("农户")
  recorded_at DateTime? @default(now()) @db.Timestamptz(6)
  batches     batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model base_locations {
  id   String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String  @unique
  type String? @default("warm")
}

model base_varieties {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String @unique
  days Int?   @default(90)
}

model inspections {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id    String    @db.Uuid
  stage       String    @default("harvest") // planting, harvest, transport, market
  result      String    @default("pass") // pass, fail, warning
  report_data Json      @default("{}") // Stores flexible data like sugar, pesticide, images
  inspector   String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  batches     batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model feedbacks {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id    String    @db.Uuid
  rating      Int       @default(5)
  content     String?
  consumer    String?   @default("Anonymous")
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  batches     batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model logistics {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id    String    @db.Uuid
  stage       String    // sorting/packing/storage/transport/delivery
  operator    String?
  location    String?
  temperature Decimal?  @db.Decimal(5, 2)
  humidity    Decimal?  @db.Decimal(5, 2)
  vehicle_info Json?    @default("{}")
  route_info  Json?     @default("{}")
  notes       String?
  images      String[]
  recorded_at DateTime? @default(now()) @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  batches     batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model alerts {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id    String    @db.Uuid
  alert_type  String    // pesticide_exceed/quality_complaint/env_abnormal/inspection_fail
  alert_level String    @default("medium") // low/medium/high/urgent
  title       String
  description String?
  triggered_by String?  // inspection/feedback/system
  trigger_data Json?    @default("{}")
  status      String    @default("pending") // pending/processing/resolved/closed
  assigned_to String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  batches     batches   @relation(fields: [batch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  disposals   disposals[]
}

model disposals {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  alert_id          String    @db.Uuid
  responsible_party String?
  action_taken      String
  result            String?
  attachments       String[]
  handler           String?
  handled_at        DateTime? @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  alerts            alerts    @relation(fields: [alert_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}
